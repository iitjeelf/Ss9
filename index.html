<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>LFJC Online Exam</title>
<style>
/* === SAME DESIGN, UNCHANGED === */
body{font-family:"SF Pro Display",Arial,sans-serif;margin:0;background:#fff;color:#000;}
header{background:linear-gradient(145deg,#E6E6FA,#D8BFD8);color:#4B0082;text-align:center;padding:20px;font-size:36px;font-weight:700;letter-spacing:1.5px;box-shadow:0 5px #aaa;text-shadow:0 1px 2px #fff;}
#studentEntry,#examArea{padding:20px;text-align:center;}
.form-group{display:flex;flex-direction:row;align-items:center;justify-content:center;margin-bottom:15px;}
.form-group label{font-size:1.15rem;font-weight:600;margin-right:10px;color:#4B0082;width:120px;text-align:right;}
input[type="text"]{padding:10px 12px;font-size:1.1rem;border-radius:10px;border:1.5px solid #4B0082;outline:none;min-width:250px;}
input.error{animation:glowRed 0.5s alternate infinite;border-color:red;}
@keyframes glowRed{0%{box-shadow:0 0 5px red;}100%{box-shadow:0 0 15px red;}}
button{position:relative;overflow:hidden;cursor:pointer;border:none;border-radius:12px;transition:all .18s ease;box-shadow:0 6px #aaa;background:linear-gradient(to bottom,#fafaff,#dcd6f7);color:#4B0082;font-weight:600;padding:10px 20px;font-size:18px;}
button:hover{transform:translateY(-2px);box-shadow:0 8px 15px rgba(0,0,0,.28);}
button:active{transform:translateY(3px) scale(.98);}
.optBtn{font-size:16px;padding:8px 18px;margin:6px;border:2px solid #4B0082;background:#fff;border-radius:8px;box-shadow:0 5px #aaa;}
.optBtn.selected{background:#32CD32;color:#fff;border-color:#2fa92f;}
.navContainer{display:flex;justify-content:center;gap:10px;margin:10px 0;flex-wrap:wrap}
.navBtn{font-size:16px;padding:10px 20px;border-radius:8px;color:#fff;font-weight:bold;cursor:pointer;background:linear-gradient(145deg,#1E90FF,#4682B4);}
#markReviewBtn{background:linear-gradient(145deg,#ffb84d,#ff9900)}
#submitBtn{background:linear-gradient(145deg,#c8b88a,#b49e60)}
#timerEl{font-size:20px;font-weight:bold;color:#4B0082;padding:6px 12px;border-radius:6px;background:#f0f0ff;display:inline-block;transition: all 0.3s ease;}
#timerEl.blink{animation:blinkTimer 1s infinite;}
@keyframes blinkTimer{0%{background:#ff6666;color:#fff;}50%{background:#fff;color:#4B0082;}100%{background:#ff6666;color:#fff;}}
#paletteContainer button{width:36px;height:36px;border-radius:50%;font-size:14px;margin:3px;border:1px solid #4B0082;background:#E6E6FA;color:#4B0082;}
#paletteContainer button.selected{background:#32CD32;color:#fff;border-color:#2fa92f}
#paletteContainer button.reviewed{background:yellow;color:#000}
#paletteContainer button.current{border:3px solid red}
footer{background:#E6E6FA;color:#4B0082;padding:10px;text-align:center;font-weight:bold;position:fixed;width:100%;bottom:0;}
.sectionTitle{font-size:22px;color:#4B0082;font-weight:bold;margin-bottom:8px;}
img.questionImg{max-width:100%;border-radius:10px;}
/* admin overlay (keeps style neutral but only visible when blocked) */
#adminOverlay{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;z-index:9999;}
#adminBox{background:#fff;padding:18px;border:2px solid #4B0082;border-radius:10px;box-shadow:0 8px 25px rgba(0,0,0,0.25);text-align:center;}
#adminBox input{padding:8px 10px;border-radius:8px;border:1px solid #4B0082;margin-right:8px;}
@media(max-width:600px){.form-group{flex-direction:column;align-items:flex-start;}.form-group label{text-align:left;width:auto;margin-bottom:5px;}}
</style>
</head>
<body>
<header>LFJC ONLINE EXAMINATION</header>

<div id="studentEntry">
  <div class="form-group"><label>Name</label><input type="text" id="stuName" placeholder="Only letters & spaces" autocomplete="off" autocapitalize="words"></div>
  <div class="form-group"><label>Section</label><input type="text" id="stuSection" placeholder="Letters & digits" autocomplete="off"></div>
  <div class="form-group"><label>Roll</label><input type="text" id="stuRoll" placeholder="Digits only" autocomplete="off"></div>
  <div class="form-group"><label>Admission No</label><input type="text" id="stuAdm" placeholder="Digits only" autocomplete="off"></div>
  <div class="form-group"><button id="stuStartBtn" style="display:none;">Start Exam</button></div>
  <p id="studentMsg"></p>
</div>

<div id="examArea" style="display:none;">
  <div id="examHeader" style="display:flex;justify-content:space-between;align-items:center;">
    <div id="stuInfo" style="text-align:left;font-weight:bold;"></div>
    <div id="stuQInfo" style="text-align:center;"></div>
    <div id="timerEl">ðŸ•’ 00:00</div>
  </div>

  <div id="questionContainer" style="text-align:center;margin-top:10px;"></div>

  <div class="navContainer">
    <button class="navBtn" id="prevBtn">â¬… Previous</button>
    <button class="navBtn" id="markReviewBtn">Review</button>
    <button class="navBtn" id="nextBtn">Next âž¡</button>
    <button class="navBtn" id="submitBtn">Submit Exam</button>
  </div>

  <div id="paletteContainer"></div>
</div>

<footer>LFJC@2025 All rights reserved</footer>

<!-- Admin overlay shown when blocked -->
<div id="adminOverlay">
  <div id="adminBox">
    <div style="font-weight:700;color:#4B0082;margin-bottom:8px;">Admin Override</div>
    <input id="adminPwd" type="password" placeholder="Enter admin password">
    <button id="adminUnlockBtn">Unlock</button>
    <div id="adminMsg" style="margin-top:8px;color:red;display:none;"></div>
  </div>
</div>

<script>
// ====== CONFIG & MARKS (edit in code if needed) ======
const SHEET_URL = "https://script.google.com/macros/s/AKfycbz1DVbfKyBz1Q8QMrhJOwUK3maEqXyrL50A4cGLmcIzfNO8VVGT3oSJ651laosOgCAm/exec";
const MARK_PER_CORRECT = 1;      // edit here if different
const MARK_PER_WRONG = -0.25;    // edit here for negative marking (0 if none)

// ====== IMAGES & KEYS (6 questions example) ======
let images = ["1.png","2.png","3.png","4.png","5.png","6.png"]; // any number works
let answerKey = ["A","B","C","D","A","B"]; // must match count of images

// Subjects (fixed names)
const subjects = ["Maths","Physics","Chemistry"];

// examData containers
let examData = { files: [], subjectNames: [], keys: [] };

// ====== SHUFFLE HELPERS ======
function shuffleArray(arr){
  const copy = arr.slice();
  for (let i = copy.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [copy[i], copy[j]] = [copy[j], copy[i]];
  }
  return copy;
}

// ====== COOKIE HELPERS (24-hour cookie per student) ======
function makeStudentId(name,sec,roll,adm){
  const key = `${name}|${sec}|${roll}|${adm}`;
  try { return btoa(unescape(encodeURIComponent(key))); } catch(e){ return encodeURIComponent(key); }
}
function setAttemptCookieForStudent(studentId){
  const d = new Date();
  d.setTime(d.getTime() + (24*60*60*1000)); // 24 hours
  const expires = "expires="+ d.toUTCString();
  document.cookie = `lfjc_${studentId}=1;${expires};path=/`;
}
function hasAttemptCookie(studentId){
  const name = `lfjc_${studentId}=`;
  const ca = document.cookie.split(';');
  for(let i=0;i<ca.length;i++){
    let c = ca[i].trim();
    if (c.indexOf(name) === 0) return true;
  }
  return false;
}
function removeAttemptCookie(studentId){
  // set expiry in past
  document.cookie = `lfjc_${studentId}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
}

// ====== PREPARE EXAM: divide equally, shuffle inside, shuffle subjects ======
function prepareExamData(){
  examData.files = []; examData.subjectNames = []; examData.keys = [];
  const total = images.length;
  const base = Math.floor(total / 3);
  let remainder = total % 3;
  let start = 0;
  const groups = [];

  for (let s = 0; s < 3; s++){
    const count = base + (remainder > 0 ? 1 : 0);
    remainder--;
    const groupImgs = images.slice(start, start + count);
    const groupKeys = answerKey.slice(start, start + count);
    start += count;
    // shuffle inside group
    const idxs = Array.from({length: groupImgs.length}, (_,i)=>i);
    const shuffledIdxs = shuffleArray(idxs);
    const shuffledImgs = shuffledIdxs.map(i => groupImgs[i]);
    const shuffledKeys = shuffledIdxs.map(i => groupKeys[i]);
    groups.push({ name: subjects[s], imgs: shuffledImgs, keys: shuffledKeys });
  }

  // shuffle subject order
  const shuffledGroups = shuffleArray(groups);

  // flatten
  shuffledGroups.forEach(g=>{
    g.imgs.forEach((img, i)=>{
      examData.files.push(img);
      examData.keys.push(g.keys[i]);
      examData.subjectNames.push(g.name);
    });
  });
}

// ====== VALIDATION & CORE LOGIC ======
let progress = null, timerInterval = null;

// store current attempt details temporarily (not persisted) so admin unlock can open directly
let pendingAttempt = null;

function validateStudentInputs(){
  const name=document.getElementById('stuName');
  const sec=document.getElementById('stuSection');
  const roll=document.getElementById('stuRoll');
  const adm=document.getElementById('stuAdm');
  // allow dot in name
  let validName=/^[A-Za-z .]+$/.test(name.value);
  let validSec=/^[A-Za-z0-9]+$/.test(sec.value);
  let validRoll=/^[0-9]+$/.test(roll.value);
  let validAdm=/^[0-9]+$/.test(adm.value);
  name.classList.toggle('error',!validName && name.value!=="");
  sec.classList.toggle('error',!validSec && sec.value!=="");
  roll.classList.toggle('error',!validRoll && roll.value!=="");
  adm.classList.toggle('error',!validAdm && adm.value!=="");
  const allValid = validName && validSec && validRoll && validAdm;
  document.getElementById('stuStartBtn').style.display = allValid ? 'inline-block' : 'none';
  return allValid;
}
['stuName','stuSection','stuRoll','stuAdm'].forEach(id=>document.getElementById(id).addEventListener('input',validateStudentInputs));

// Start with confirmation and cookie check (cookie set only at submission)
document.getElementById('stuStartBtn').onclick = () => {
  if (!validateStudentInputs()) return;

  // read entered details
  const name = document.getElementById('stuName').value.trim();
  const sec = document.getElementById('stuSection').value.trim();
  const roll = document.getElementById('stuRoll').value.trim();
  const adm = document.getElementById('stuAdm').value.trim();

  const studentId = makeStudentId(name,sec,roll,adm);

  // check cookie - if present, block and show admin overlay
  if (hasAttemptCookie(studentId)){
    // clear input fields (do not display entered details anywhere)
    document.getElementById('stuName').value = '';
    document.getElementById('stuSection').value = '';
    document.getElementById('stuRoll').value = '';
    document.getElementById('stuAdm').value = '';
    pendingAttempt = { name, sec, roll, adm };

    // show red full-page block and admin overlay
    document.body.style.background = 'red';
    // disable pointer events on main content
    document.getElementById('studentEntry').style.pointerEvents = 'none';
    document.getElementById('examArea').style.pointerEvents = 'none';
    // show admin overlay
    document.getElementById('adminOverlay').style.display = 'flex';
    document.getElementById('adminMsg').style.display = 'none';
    return;
  }

  // confirmation
  const ok = confirm("Are you sure you want to START the exam? Once started, timer will begin.");
  if (!ok) return;

  // clear input fields to avoid showing last entered details later
  document.getElementById('stuName').value = '';
  document.getElementById('stuSection').value = '';
  document.getElementById('stuRoll').value = '';
  document.getElementById('stuAdm').value = '';

  // proceed: prepare exam and start
  prepareExamData();
  progress = {
    answers: Array(examData.files.length).fill(null),
    review: Array(examData.files.length).fill(false),
    currentIndex: 0,
    student: { name, sec, roll, adm, date: new Date().toLocaleDateString() },
    timeLeftSec: 5 * 60
  };
  document.getElementById('studentEntry').style.display = 'none';
  document.getElementById('examArea').style.display = 'block';
  renderQuestion(); renderPalette(); startTimer();
};

// Admin unlock button (when blocked)
document.getElementById('adminUnlockBtn').onclick = () => {
  const pwd = document.getElementById('adminPwd').value;
  const adminMsg = document.getElementById('adminMsg');
  if (pwd === 'lfjc2025') {
    adminMsg.style.display = 'none';
    document.getElementById('adminPwd').value = '';
    document.getElementById('adminOverlay').style.display = 'none';
    // restore background and pointer events
    document.body.style.background = '';
    document.getElementById('studentEntry').style.pointerEvents = '';
    document.getElementById('examArea').style.pointerEvents = '';

    // directly open exam using pendingAttempt (do not show entered values in prompts)
    if (pendingAttempt) {
      prepareExamData();
      progress = {
        answers: Array(examData.files.length).fill(null),
        review: Array(examData.files.length).fill(false),
        currentIndex: 0,
        student: { name: pendingAttempt.name, sec: pendingAttempt.sec, roll: pendingAttempt.roll, adm: pendingAttempt.adm, date: new Date().toLocaleDateString() },
        timeLeftSec: 5 * 60
      };
      pendingAttempt = null;
      document.getElementById('studentEntry').style.display = 'none';
      document.getElementById('examArea').style.display = 'block';
      renderQuestion(); renderPalette(); startTimer();
    }
  } else {
    adminMsg.style.display = 'block';
    adminMsg.textContent = 'Incorrect password';
  }
};

// Timer
function startTimer(){
  const timerEl=document.getElementById('timerEl');
  const stuInfo=document.getElementById('stuInfo');
  const stuQInfo=document.getElementById('stuQInfo');
  timerInterval = setInterval(()=>{
    if(progress.timeLeftSec <= 0){ clearInterval(timerInterval); alert("Time's up! Submitting automatically."); submitExam(); return; }
    progress.timeLeftSec--;
    const min = Math.floor(progress.timeLeftSec / 60);
    const sec = progress.timeLeftSec % 60;
    timerEl.textContent = `ðŸ•’ ${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
    // show only entered values (no labels)
    stuInfo.textContent = `${progress.student.name} | ${progress.student.sec} | ${progress.student.roll} | ${progress.student.adm}`;
    stuQInfo.textContent = `Q ${progress.currentIndex+1}/${examData.files.length}`;
    if(progress.timeLeftSec <= 300) timerEl.classList.add('blink'); else timerEl.classList.remove('blink');
    if(progress.timeLeftSec <= 60) { stuInfo.classList.add('blink'); } else stuInfo.classList.remove('blink');
  }, 1000);
}

// Render question
function renderQuestion(){
  const q = document.getElementById('questionContainer');
  const file = examData.files[progress.currentIndex];
  const subj = examData.subjectNames[progress.currentIndex];
  q.innerHTML = `<div class="sectionTitle">${subj}</div>
                 <img src="${file}" class="questionImg" alt="Q${progress.currentIndex+1}"><br>`;
  ["A","B","C","D"].forEach(opt=>{
    const btn = document.createElement('button');
    btn.className = 'optBtn';
    btn.textContent = opt;
    if(progress.answers[progress.currentIndex] === opt) btn.classList.add('selected');
    btn.onclick = () => {
      progress.answers[progress.currentIndex] = opt;
      document.querySelectorAll('.optBtn').forEach(b=>b.classList.remove('selected'));
      btn.classList.add('selected');
      renderPalette();
    };
    q.appendChild(btn);
  });
}

// Navigation
document.getElementById('nextBtn').onclick = ()=>{ if(progress.currentIndex < examData.files.length-1){ progress.currentIndex++; renderQuestion(); renderPalette(); } };
document.getElementById('prevBtn').onclick = ()=>{ if(progress.currentIndex > 0){ progress.currentIndex--; renderQuestion(); renderPalette(); } };
document.getElementById('markReviewBtn').onclick = ()=>{ progress.review[progress.currentIndex] = !progress.review[progress.currentIndex]; renderPalette(); };

// Palette
function renderPalette(){
  const cont = document.getElementById('paletteContainer');
  cont.innerHTML = '';
  progress.answers.forEach((ans,i)=>{
    const b = document.createElement('button');
    b.textContent = i+1;
    if(i === progress.currentIndex) b.classList.add('current');
    if(progress.review[i]) b.classList.add('reviewed');
    if(ans) b.classList.add('selected');
    b.onclick = ()=>{ progress.currentIndex = i; renderQuestion(); renderPalette(); };
    cont.appendChild(b);
  });
}

// Send to Google Sheet
function sendToSheet(data){
  try {
    fetch(SHEET_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) });
  } catch(e){}
}

// Submit (confirmation then compute)
document.getElementById('submitBtn').onclick = ()=> {
  if(confirm("Are you sure you want to submit your exam?")) submitExam();
};

function submitExam(){
  clearInterval(timerInterval);

  // subject-wise stats
  const subjStats = {}; // { subjectName: {correct, wrong, blank, total} }
  for (let i=0; i<examData.files.length; i++){
    const subj = examData.subjectNames[i];
    if(!subjStats[subj]) subjStats[subj] = { correct:0, wrong:0, blank:0, total:0 };
    subjStats[subj].total++;
    const given = progress.answers[i];
    const key = examData.keys[i];
    if(!given) subjStats[subj].blank++;
    else if(given === key) subjStats[subj].correct++;
    else subjStats[subj].wrong++;
  }

  // totals
  let grandCorrect = 0, grandWrong = 0, grandBlank = 0, grandTotal = 0;
  Object.keys(subjStats).forEach(subj => {
    const s = subjStats[subj];
    grandCorrect += s.correct;
    grandWrong += s.wrong;
    grandBlank += s.blank;
    grandTotal += s.total;
  });

  // overall marks & %
  const totalMarks = (grandCorrect * MARK_PER_CORRECT) + (grandWrong * MARK_PER_WRONG);
  const maxMarks = grandTotal * MARK_PER_CORRECT;
  const overallPercent = maxMarks ? ((totalMarks / maxMarks) * 100).toFixed(2) : '0.00';

  // set 24-hour cookie for this student (prevents re-entry)
  const studentId = makeStudentId(progress.student.name, progress.student.sec, progress.student.roll, progress.student.adm);
  setAttemptCookieForStudent(studentId);

  // send to sheet
  sendToSheet({
    name: progress.student.name,
    section: progress.student.sec,
    roll: progress.student.roll,
    adm: progress.student.adm,
    subjectWise: subjStats,
    correct: grandCorrect,
    wrong: grandWrong,
    blank: grandBlank,
    total: grandTotal,
    marks: totalMarks,
    percent: overallPercent,
    answers: progress.answers
  });

  // hide exam and show result
  document.getElementById('examArea').style.display = 'none';
  document.getElementById('studentEntry').style.display = 'none';

  // build subject rows + totals row
  let subjRows = '';
  Object.keys(subjStats).forEach(subj => {
    const s = subjStats[subj];
    const percent = s.total ? ((s.correct / s.total) * 100).toFixed(2) : '0.00';
    subjRows += `<tr>
      <td style="padding:8px;border:1px solid #ccc;text-align:left;">${subj}</td>
      <td style="padding:8px;border:1px solid #ccc;text-align:center;">${s.correct}</td>
      <td style="padding:8px;border:1px solid #ccc;text-align:center;">${s.wrong}</td>
      <td style="padding:8px;border:1px solid #ccc;text-align:center;">${s.blank}</td>
      <td style="padding:8px;border:1px solid #ccc;text-align:center;">${s.total}</td>
      <td style="padding:8px;border:1px solid #ccc;text-align:center;">${percent}%</td>
    </tr>`;
  });

  // totals row
  const totalPercent = grandTotal ? ((grandCorrect / grandTotal) * 100).toFixed(2) : '0.00';
  const totalsRow = `<tr style="font-weight:bold;background:#f9f9f9;">
    <td style="padding:8px;border:1px solid #ccc;text-align:left;">Totals</td>
    <td style="padding:8px;border:1px solid #ccc;text-align:center;">${grandCorrect}</td>
    <td style="padding:8px;border:1px solid #ccc;text-align:center;">${grandWrong}</td>
    <td style="padding:8px;border:1px solid #ccc;text-align:center;">${grandBlank}</td>
    <td style="padding:8px;border:1px solid #ccc;text-align:center;">${grandTotal}</td>
    <td style="padding:8px;border:1px solid #ccc;text-align:center;">${totalPercent}%</td>
  </tr>`;

  // result element
  const resultDiv = document.createElement('div');
  resultDiv.id = "resultArea";
  resultDiv.style.padding = "20px";
  resultDiv.style.textAlign = "center";

  // show only entered values (no labels) under the congratulations header
  const studentInfoLine = `${progress.student.name} | ${progress.student.sec} | ${progress.student.roll} | ${progress.student.adm}`;

  resultDiv.innerHTML = `
    <h2>Congratulations ${progress.student.name}!</h2>
    <p style="margin-top:6px;">${studentInfoLine}</p>

    <h3 style="color:#4B0082;margin-top:10px;">Subject-wise Summary</h3>
    <div style="display:flex;justify-content:center;">
      <table style="border-collapse:collapse;width:90%;max-width:820px;">
        <thead>
          <tr>
            <th style="padding:8px;border:1px solid #ccc;text-align:left;background:#f5f5ff;">Subject</th>
            <th style="padding:8px;border:1px solid #ccc;text-align:center;background:#f5f5ff;">Correct</th>
            <th style="padding:8px;border:1px solid #ccc;text-align:center;background:#f5f5ff;">Wrong</th>
            <th style="padding:8px;border:1px solid #ccc;text-align:center;background:#f5f5ff;">Blank</th>
            <th style="padding:8px;border:1px solid #ccc;text-align:center;background:#f5f5ff;">Total</th>
            <th style="padding:8px;border:1px solid #ccc;text-align:center;background:#f5f5ff;">%</th>
          </tr>
        </thead>
        <tbody>
          ${subjRows}
          ${totalsRow}
        </tbody>
      </table>
    </div>

    <h3 style="color:#4B0082;margin-top:16px;">Overall</h3>
    <p style="font-size:16px;"><b>Correct:</b> ${grandCorrect} | <b>Wrong:</b> ${grandWrong} | <b>Blank:</b> ${grandBlank} | <b>Total Questions:</b> ${grandTotal}</p>
    <p style="font-size:18px;"><b>Total Marks:</b> ${totalMarks} &nbsp; | &nbsp; <b>Overall %:</b> ${overallPercent}%</p>

    <div style="margin-top:18px;">
      <button id="logoutBtn" style="padding:10px 18px;border-radius:8px;">Logout</button>
    </div>
  `;

  document.body.appendChild(resultDiv);

  // Logout: attempt to close tab; fallback to blank and prevent back
  document.getElementById('logoutBtn').onclick = () => {
    try {
      window.close();
      setTimeout(()=>{
        try { window.open('','_self'); window.close(); } catch(e){}
        setTimeout(()=>{ window.location.href = 'about:blank'; }, 200);
      }, 200);
    } catch(e){
      try { window.location.href = 'about:blank'; } catch(err){ location.reload(); }
    }
  };
}
</script>
</body>
</html>
